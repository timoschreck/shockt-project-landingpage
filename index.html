<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>shockT project</title>
    <!-- Import Google Fonts for a graffiti and modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <!-- Hero Section -->
    <header class="hero">
        <div class="overlay">
            <!-- Insert image logo instead of text heading -->
            <img src="header_logo.png" alt="shockT project logo" class="header-logo" />
            <p class="tagline">Deutschrap. Pop. Schmerz. Club.</p>
            <a href="#music" class="btn primary">Hör jetzt rein</a>
        </div>
    </header>

    <!-- About Section -->
    <section id="about" class="about section">
        <h2>Über mich</h2>
        <p>
            Ich mach Musik zwischen Rausch und Realität. Zwischen Pop und Schmerz.
            Zwischen Club und Kopfkino. <strong>shockT project</strong> ist kein Act – es ist
            ein Zustand.
        </p>
    </section>

    <!-- Music Section -->
    <section id="music" class="music section">
        <h2>Meine Tracks</h2>
        <!-- Album cover displayed first. Clicking on it will reveal the songs list -->
            <div class="album-container">
                <img id="album-cover" src="album_cover.png" alt="No.1 – Von Sehnsucht, Zweifel und Kraft Album Cover" />
            </div>
            <!-- Back button for returning to the album cover view. Hidden by default and shown when songs are visible. -->
            <button id="back-button" class="btn secondary" style="display:none; margin: 1rem auto;">Zurück</button>
            <!-- Song list hidden by default. It will be shown when the album cover is clicked -->
            <div id="album-songs" class="songs">
            <div class="song">
           <h3>Fremdes Glück</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                        <source src="songs/Fremdes Glück.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <!-- Hidden play count counter -->
                <span class="play-count" data-key="fremdes-glueck">0</span>
            </div>
            <div class="song">
                <h3>Genau Hier</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Genau Hier.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="genau-hier">0</span>
            </div>
            <div class="song">
                <h3>Magie</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Magie.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="magie">0</span>
            </div>
            <div class="song">
                <h3>Heute wird’s geil</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Heute_wirds_geil.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="heute-wirds-geil">0</span>
            </div>
            <div class="song">
                <h3>Sehnsucht, Freiheit</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Sehnsucht, Freiheit.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="sehnsucht-freiheit">0</span>
            </div>
            <div class="song">
                <h3>Sonne im Block</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Sonne im Block.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="sonne-im-block">0</span>
            </div>
            <div class="song">
                <h3>Step by Step (Selbstrespekt)</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Step by Step (Selbstrespekt).mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="step-by-step-selbstrespekt">0</span>
            </div>
            <div class="song">
                <h3>Traum bleibt</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Traum bleibt.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="traum-bleibt">0</span>
            </div>
            <div class="song">
                <h3>Was kommt</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Was kommt.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="was-kommt">0</span>
            </div>
            <div class="song">
                <h3>Zurück im Licht</h3>
                <audio controls controlsList="nodownload" oncontextmenu="return false;">
                    <source src="songs/Zurück im Licht.mp3" type="audio/mpeg" />
                    Dein Browser unterstützt das Audioelement nicht.
                </audio>
                <span class="play-count" data-key="zurueck-im-licht">0</span>
            </div>
        </div>
        <!-- Button to open the album player. Shows an overlay with controls for sequential playback -->
        <button id="play-all-btn" class="btn primary" style="margin: 1rem auto; display: block;">
            Komplettes Album anhören
        </button>
        <!-- Album player overlay. Contains controls to navigate through the album when playing all songs -->
        <div id="album-player" class="album-player" style="display: none;">
            <p class="album-player-title"><strong>Album Player</strong></p>
            <div class="player-controls">
                <button id="prev-song-btn" class="btn secondary">Vorheriger Song</button>
                <button id="stop-player-btn" class="btn secondary">Stopp</button>
                <button id="next-song-btn" class="btn secondary">Nächster Song</button>
            </div>
        </div>
    </section>

    <!-- Radio shockT Album Section -->
<section id="radio-music" class="music section">
    <h2>Radio shockT</h2>
    <div class="album-container">
        <img id="radio-album-cover" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAyADIDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDzvJbhn496MkfKH4/Sj73Cpz7Zo6fKU5/HNbjvLe/z118gyV+6/X0zR0+YPz+OaMFfvJ19c0YI+Ypx+lAe9/V9PMPvcs/PvmjJbhn496MFuVTj2o+9wqc+2aA97+r6htH99f1oo2P/AHG/KigOWX8n5/5iHb2JP1FHy46nP0pcFefl/Q0YJ+b5f0/lQLl1+HXtr9+4gx3JH0FHGepx9KXl/wC7x9BRkn5fl/T+dILLt+G/4/kIcZ4JP1FB29iT9RS5K8fL+howV5+X9DQFlrp66bfj+Y2inbz6L/3yKKCbQ7v7v+CIMZ5BP0NHGehx9aXJbhn496MkfKH4/SgdlbfT5X/MQ47Aj6mj5cdDn60uSv3X6+maOnzB+fxzTH/T2/AQbe4J+hoGM8gn6Gl+9yz8++aMluGfj3oDt+G34/8ABDKf3W/P/wCtRRtH99f1ooH7/l/5KNooopGIUUUUAFFFFABRRRQB/9k=" alt="Radio shockT Album Cover" />
    </div>
    <button id="radio-back-button" class="btn secondary" style="display:none; margin: 1rem auto;">Zurück</button>
    <div id="radio-songs" class="songs">
        <!-- Songs für Radio shockT werden später hinzugefügt -->
    </div>
    <button id="radio-play-all-btn" class="btn primary" style="margin: 1rem auto; display: none;">
        Komplettes Album anhören
    </button>
    <div id="radio-album-player" class="album-player" style="display: none;">
        <p class="album-player-title"><strong>Album Player</strong></p>
        <div class="player-controls">
            <button id="radio-prev-song-btn" class="btn secondary">Vorheriger Song</button>
            <button id="radio-stop-player-btn" class="btn secondary">Stopp</button>
            <button id="radio-next-song-btn" class="btn secondary">Nächster Song</button>
        </div>
    </div>
</section>

<!-- Contact Section -->
    <section id="contact" class="contact section">
        <h2>Kontakt / Booking</h2>
        <!--
            Die Kontakt‑/Booking‑Sektion enthielt bisher nur ein Formular ohne
            serverseitige Verarbeitung. Dadurch wurden die eingegebenen Daten
            lediglich an die URL angehängt (GET‑Parameter) und es erfolgte keine
            Zustellung der Nachricht an den Künstler. Um eine einfache und
            zuverlässige Übermittlung per E‑Mail zu ermöglichen, verwenden wir
            hier ein `mailto:`‑Formular.  Beim Absenden öffnet sich der
            Standard‑E‑Mail‑Client des Nutzers mit einer vorbefüllten
            Nachricht an die im Impressum hinterlegte Adresse.  Die Felder
            „Name“, „E‑Mail“ und „Nachricht“ werden dabei als
            Parameter übergeben.

            Hinweis: Diese Lösung erfordert keinen eigenen Back‑End‑Server,
            sendet aber auch keine Daten automatisch.  Benutzer können die
            vorgefertigte E‑Mail noch anpassen, bevor sie sie endgültig
            versenden.  Sollte künftig ein serverseitiges Skript oder ein
            externer Dienst wie Formspree genutzt werden, kann das
            `action`‑Attribut entsprechend angepasst werden.
        -->
        <form class="contact-form"
              action="mailto:contact@shockt-project.de"
              method="post"
              enctype="text/plain">
            <input type="text" name="Name" placeholder="Name" required />
            <input type="email" name="Email" placeholder="E‑Mail" required />
            <textarea name="Nachricht" placeholder="Nachricht" rows="4" required></textarea>
            <button type="submit" class="btn secondary">Senden</button>
        </form>
    </section>

    <!-- Legal Section: Impressum, Urheberrecht und Datenschutz -->
    <section id="legal" class="legal section">
        <h2>Impressum &amp; Datenschutz</h2>
        <h3>Impressum</h3>
        <p>
            shockT project<br />
            Timo Schreck<br />
            Villinger Straße&nbsp;20<br />
            68239 Mannheim, Deutschland<br />

            E‑Mail: <a href="mailto:contact@shockt-project.de">contact@shockt-project.de</a>
        </p>
        <p>
            Verantwortlich für den Inhalt nach §&nbsp;18&nbsp;Abs.&nbsp;2&nbsp;MStV: Timo Schreck, Anschrift wie oben.
        </p>
        <h3>Urheberrecht</h3>
        <p>
            Alle Inhalte dieser Website, insbesondere Texte, Bilder und Audiodateien, sind urheberrechtlich
            geschützt. Alle Lieder sind Eigentum von shockT project und weltweit lizenzrechtlich geschützt.
            Die Vervielfältigung, Bearbeitung, Verbreitung und jede Art der Verwertung außerhalb der Grenzen
            des Urheberrechts bedürfen der vorherigen schriftlichen Zustimmung des Urhebers. Downloads und
            Kopien dieser Seite sind nur für den privaten, nicht kommerziellen Gebrauch gestattet.
        </p>
        <h3>Datenschutzerklärung</h3>
        <p>
            Wir nehmen den Schutz Ihrer persönlichen Daten ernst. Personenbezogene Daten (z.&nbsp;B. Name, E‑Mail),
            die Sie uns im Kontaktformular mitteilen, werden nur zur Bearbeitung Ihrer Anfrage genutzt und nicht
            ohne Ihre ausdrückliche Zustimmung an Dritte weitergegeben. Beim Abspielen der Songs werden keine
            personenbezogenen Daten an uns übermittelt; die lokalen Wiedergabedaten werden lediglich in Ihrem Browser
            gespeichert (localStorage) und nicht an den Server übertragen. Weitere Analyse‑ oder Tracking‑Tools werden
            nicht eingesetzt. Sie haben jederzeit das Recht auf Auskunft, Berichtigung oder Löschung Ihrer bei uns
            gespeicherten Daten sowie das Recht auf Beschwerde bei der zuständigen Aufsichtsbehörde.
        </p>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 shockT project. Alle Rechte vorbehalten.</p>
        <div class="social-links">
            <a href="https://instagram.com" target="_blank">Instagram</a>
            <a href="https://spotify.com" target="_blank">Spotify</a>
            <a href="https://youtube.com" target="_blank">YouTube</a>
            <a href="https://tiktok.com" target="_blank">TikTok</a>
        </div>
        <div class="footer-links">
            <a href="#legal">Impressum &amp; Datenschutz</a>
        </div>
    </footer>

    <!-- User Info Modal for collecting mandatory user data before ratings/comments -->
    <div id="user-info-modal" class="user-modal" style="display: none;">
        <div class="user-modal-content">
            <h3>Bitte registrieren Sie sich</h3>
            <p>Um Bewertungen und Kommentare abzugeben, benötigen wir Ihren Vor- und Nachnamen sowie E-Mail oder Telefonnummer.</p>
            <input type="text" id="firstName" placeholder="Vorname" required />
            <input type="text" id="lastName" placeholder="Name" required />
            <input type="email" id="userEmail" placeholder="E-Mail" />
            <input type="tel" id="userPhone" placeholder="Telefonnummer" />
            <p id="user-info-error" class="error-message" style="display:none;">Bitte füllen Sie alle Pflichtfelder aus.</p>
            <button id="user-info-submit" class="btn primary" style="margin-top: 1rem;">Informationen absenden</button>
        </div>
    </div>

    <!-- Script to toggle visibility of songs when album cover is clicked
         and to track play counts for each song. The play counts are stored
         in localStorage and updated on each play event. The counters are hidden
         from the user but increment behind the scenes. -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var cover = document.getElementById('album-cover');
            var songsContainer = document.getElementById('album-songs');
            var backButton = document.getElementById('back-button');
            // Hide songs container and back button initially
                    // Setup variables for Radio shockT album
        var radioCover = document.getElementById('radio-album-cover');
        var radioSongsContainer = document.getElementById('radio-songs');
        var radioBackButton = document.getElementById('radio-back-button');
        var radioPlayAllBtn = document.getElementById('radio-play-all-btn');
        var radioAlbumPlayer = document.getElementById('radio-album-player');
        var radioPrevBtn = document.getElementById('radio-prev-song-btn');
        var radioNextBtn = document.getElementById('radio-next-song-btn');
        var radioStopBtn = document.getElementById('radio-stop-player-btn');
        // Hide radio songs and back button initially
        if (radioSongsContainer) {
            radioSongsContainer.style.display = 'none';
        }
        if (radioBackButton) {
            radioBackButton.style.display = 'none';
        }
        if (radioPlayAllBtn) {
            radioPlayAllBtn.style.display = 'none';
        }
        // Click handler for radio album cover with password check
        if (radioCover && radioSongsContainer && radioBackButton) {
            radioCover.addEventListener('click', function () {
                var password = prompt('Bitte Passwort eingeben:');
                if (password === 'Evo2025') {
                    radioSongsContainer.style.display = 'grid';
                    radioBackButton.style.display = 'inline-block';
                    if (radioSongsContainer.querySelectorAll('audio').length > 0 && radioPlayAllBtn) {
                        radioPlayAllBtn.style.display = 'block';
                    }
                } else if (password !== null) {
                    alert('Falsches Passwort!');
                }
            });
            radioBackButton.addEventListener('click', function () {
                radioSongsContainer.style.display = 'none';
                radioBackButton.style.display = 'none';
                if (radioPlayAllBtn) {
                    radioPlayAllBtn.style.display = 'none';
                }
                if (radioAlbumPlayer) {
                    radioAlbumPlayer.style.display = 'none';
                }
            });
        }
        // Radio album sequential playback
        var radioAudios = Array.prototype.slice.call(document.querySelectorAll('#radio-songs audio'));
        var radioCurrentAudio = null;
        var radioPlaying = false;
        var radioPlayIndex = 0;
        function playRadioSong(index) {
            if (index < 0 || index >= radioAudios.length) {
                return;
            }
            if (radioCurrentAudio && !radioCurrentAudio.paused) {
                radioCurrentAudio.pause();
                radioCurrentAudio.currentTime = 0;
            }
            radioCurrentAudio = radioAudios[index];
            radioPlayIndex = index;
            radioPlaying = true;
            radioCurrentAudio.play();
        }
        function playRadioNext() {
            var nextIndex = radioPlayIndex + 1;
            if (nextIndex >= radioAudios.length) {
                nextIndex = 0;
            }
            playRadioSong(nextIndex);
        }
        function playRadioPrev() {
            var prevIndex = radioPlayIndex - 1;
            if (prevIndex < 0) {
                prevIndex = radioAudios.length - 1;
            }
            playRadioSong(prevIndex);
        }
        function stopRadioAll() {
            radioPlaying = false;
            if (radioCurrentAudio) {
                radioCurrentAudio.pause();
                radioCurrentAudio.currentTime = 0;
            }
        }
        if (radioPlayAllBtn && radioAlbumPlayer) {
            radioPlayAllBtn.addEventListener('click', function () {
                radioAlbumPlayer.style.display = 'block';
                if (radioSongsContainer) {
                    radioSongsContainer.style.display = 'grid';
                }
                if (radioBackButton) {
                    radioBackButton.style.display = 'inline-block';
                }
                playRadioSong(0);
            });
        }
        if (radioNextBtn) {
            radioNextBtn.addEventListener('click', function () {
                playRadioNext();
            });
        }
        if (radioPrevBtn) {
            radioPrevBtn.addEventListener('click', function () {
                playRadioPrev();
            });
        }
        if (radioStopBtn) {
            radioStopBtn.addEventListener('click', function () {
                stopRadioAll();
            });
        }
        radioAudios.forEach(function (aud) {
            aud.addEventListener('ended', function () {
                if (radioPlaying) {
                    playRadioNext();
                }
            });
        });

            if (songsContainer) {
                songsContainer.style.display = 'none';
            }
            if (backButton) {
                backButton.style.display = 'none';
            }
            // Show songs when cover is clicked; keep the cover visible and show the back button
            if (cover && songsContainer && backButton) {
                cover.addEventListener('click', function () {
                    songsContainer.style.display = 'grid';
                    backButton.style.display = 'inline-block';
                    // keep cover visible
                });
                // Hide songs and back button when back button is clicked
                backButton.addEventListener('click', function () {
                    songsContainer.style.display = 'none';
                    backButton.style.display = 'none';
                    // cover remains visible
                });
            }
                // Initialize play counters for // var oldAudioElements = document.querySelectorAll('#album-songs audio');audioElements // = document'#album'#album-songs audio'audio, #radio-songs audio'('#album-s, #radio-songs audioongs audio');
                    var audioElements = document.querySelectorAll('#album-songs audio, #radio-songs audio');

                // Track the currently playing audio so that only one song plays at a time.
        var currentAudio = null;

        // Increment page view counter with timestamp.  This records each visit in
        // localStorage so that weekly reports can include the number of site
        // visits.  Each entry is an ISO timestamp string.  Errors in
        // localStorage access are silently ignored to avoid breaking the page.
        try {
            var pageViews = [];
            try {
                pageViews = JSON.parse(localStorage.getItem('pageViews') || '[]');
            } catch (err) {
                pageViews = [];
            }
            pageViews.push(new Date().toISOString());
            localStorage.setItem('pageViews', JSON.stringify(pageViews));
        } catch (err) {
            // ignore storage errors
        }

            // ----- User registration modal and gating logic -----
            // References to modal elements and helper function to show the modal
            var userModal = document.getElementById('user-info-modal');
            var userSubmitBtn = document.getElementById('user-info-submit');
            var userInfoError = document.getElementById('user-info-error');
            function showUserModal() {
                if (userModal) {
                    userModal.style.display = 'flex';
                }
            }
            // Hide comment forms until the user has provided their contact information.
            // Star ratings are always visible, but comment sections are gated behind registration.
            if (!localStorage.getItem('userInfoSubmitted')) {
                document.querySelectorAll('.comment-section').forEach(function (el) {
                    el.style.display = 'none';
                });
            }
            // Handle submission of the user registration form
            if (userSubmitBtn) {
                userSubmitBtn.addEventListener('click', function () {
                    var firstNameEl = document.getElementById('firstName');
                    var lastNameEl = document.getElementById('lastName');
                    var emailEl = document.getElementById('userEmail');
                    var phoneEl = document.getElementById('userPhone');
                    var firstName = firstNameEl ? firstNameEl.value.trim() : '';
                    var lastName = lastNameEl ? lastNameEl.value.trim() : '';
                    var emailVal = emailEl ? emailEl.value.trim() : '';
                    var phoneVal = phoneEl ? phoneEl.value.trim() : '';
                    // Validate required fields: first/last name and at least one contact (email or phone)
                    if (!firstName || !lastName || (!emailVal && !phoneVal)) {
                        if (userInfoError) {
                            userInfoError.textContent = 'Bitte geben Sie Vorname, Name und E‑Mail oder Telefonnummer an.';
                            userInfoError.style.display = 'block';
                        }
                        return;
                    }
                    // Persist user data
                    var info = { firstName: firstName, lastName: lastName, email: emailVal, phone: phoneVal };
                    try {
                        localStorage.setItem('userInfo', JSON.stringify(info));
                    } catch (err) {
                        // ignore storage errors
                    }
                    localStorage.setItem('userInfoSubmitted', 'true');
                    // Hide the modal
                    if (userModal) {
                        userModal.style.display = 'none';
                    }
                    // Remove any existing rating/comment data stored in localStorage
                    Object.keys(localStorage).forEach(function (k) {
                        if (k.startsWith('ratings_') || k.startsWith('ratingCount_') || k.startsWith('lastRating_') || k.startsWith('comments_')) {
                            localStorage.removeItem(k);
                        }
                    });
                    // Show comment input sections now that the user has registered.  Ratings
                    // remain visible at all times.  Any previously collected ratings/comments
                    // have been cleared above, so new submissions will be collected for moderation.
                    document.querySelectorAll('.comment-section').forEach(function (el) {
                        el.style.display = '';
                    });
                    // Reset any error message
                    if (userInfoError) {
                        userInfoError.style.display = 'none';
                    }
                });
            }

                audioElements.forEach(function (audio) {
                var parent = audio.parentElement;
                var counter = parent.querySelector('.play-count');
                if (!counter) return;
                var key = counter.dataset.key;
                // Load stored count from localStorage if available
                if (key) {
                    var stored = localStorage.getItem('playCount_' + key);
                    if (stored !== null) {
                        counter.textContent = stored;
                    }
                }
                    // Increment counter on each play event and ensure only one audio plays at a time
                    audio.addEventListener('play', function () {
                        // If another audio is currently playing, pause it
                        if (currentAudio && currentAudio !== audio) {
                            currentAudio.pause();
                        }
                        // Update the current audio reference
                        currentAudio = audio;

                        var count = parseInt(counter.textContent) || 0;
                        count += 1;
                        counter.textContent = count;
                        if (key) {
                            localStorage.setItem('playCount_' + key, count);
                            // Also record each play with a timestamp so weekly
                            // summaries can report how many times a song was played.
                            try {
                                var histKey = 'playHistory_' + key;
                                var history = [];
                                try {
                                    history = JSON.parse(localStorage.getItem(histKey) || '[]');
                                } catch (e) {
                                    history = [];
                                }
                                history.push(new Date().toISOString());
                                localStorage.setItem(histKey, JSON.stringify(history));
                            } catch (err) {
                                // ignore errors
                            }
                            // Send play count to Supabase
                            try {
                                // Determine song title from DOM
                                var songDiv = audio.closest('.song');
                                var titleEl = songDiv ? songDiv.querySelector('h3') : null;
                                var title = titleEl ? titleEl.textContent.trim() : key;
                                if (typeof updateSongStats === 'function') {
                                    updateSongStats(key, title, 1, 0, 0, 0);
                                }
                            } catch (err) {
                                // ignore errors when Supabase is not configured
                            }
                        }
                    });
            });

            // Dynamically add rating stars and comment sections for each song
            var songItems = document.querySelectorAll('#album-songs .song');
            songItems.forEach(function (song) {
                var playCounter = song.querySelector('.play-count');
                if (!playCounter) return;
                var key = playCounter.dataset.key;
                // Rating container
                var ratingContainer = document.createElement('div');
                ratingContainer.className = 'rating';
                ratingContainer.dataset.key = key;
                // Create five stars
                for (var i = 1; i <= 5; i++) {
                    var star = document.createElement('span');
                    star.className = 'star';
                    star.dataset.value = i;
                    star.innerHTML = '\u2605'; // Unicode filled star
                    ratingContainer.appendChild(star);
                }
                /*
                 * We no longer display rating counts publicly.  Ratings are stored
                 * internally in localStorage under the key "ratings_<songKey>".  When a
                 * user rates a song, the value (1–5) is pushed to an array in
                 * localStorage.  This ensures that ratings are collected but not shown
                 * until they are approved by the site owner.  The rating container is
                 * appended directly to the song without a visible count.
                 */
                song.appendChild(ratingContainer);
                // Comment section
                var commentSection = document.createElement('div');
                commentSection.className = 'comment-section';
                var textarea = document.createElement('textarea');
                textarea.setAttribute('maxlength', '250');
                textarea.setAttribute('placeholder', 'Kommentar (max. 250 Zeichen)');
                var submitBtn = document.createElement('button');
                submitBtn.className = 'btn secondary comment-submit';
                submitBtn.textContent = 'Kommentar senden';
                var msg = document.createElement('p');
                msg.className = 'comment-message';
                msg.style.display = 'none';
                msg.textContent = 'Danke für deinen Kommentar! Er wird nach Überprüfung veröffentlicht.';
                commentSection.appendChild(textarea);
                commentSection.appendChild(submitBtn);
                commentSection.appendChild(msg);
                song.appendChild(commentSection);
            });
            // Rating click handler with user info check
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('star')) {
                    // Star ratings are collected regardless of registration.  Comments still
                    // require registration, but anyone can click on stars to rate a song.
                    var star = e.target;
                    var ratingContainer = star.parentElement;
                    var value = parseInt(star.dataset.value);
                    var stars = ratingContainer.querySelectorAll('.star');
                    stars.forEach(function (s, index) {
                        if (index < value) {
                            s.classList.add('selected');
                        } else {
                            s.classList.remove('selected');
                        }
                    });
                    var key = ratingContainer.dataset.key;
                    if (key) {
                        // Store each individual rating value in an array to be
                        // moderated later.  Comments and ratings are not publicly
                        // displayed until approved by the site owner.
                        var ratingsKey = 'ratings_' + key;
                        var ratings = [];
                        try {
                            ratings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
                        } catch (err) {
                            ratings = [];
                        }
                        // Convert any existing numeric ratings to objects with a
                        // date property so we can generate weekly summaries.  If
                        // an entry is a number, treat it as a rating with no
                        // specific date (assumed current week in reporting).
                        var normalized = [];
                        ratings.forEach(function (entry) {
                            if (typeof entry === 'number') {
                                normalized.push({ value: entry, date: null });
                            } else if (entry && typeof entry === 'object' && 'value' in entry) {
                                normalized.push(entry);
                            }
                        });
                        // Add the new rating with a timestamp
                        normalized.push({ value: value, date: new Date().toISOString() });
                        localStorage.setItem(ratingsKey, JSON.stringify(normalized));
                        // Also update a total count to track how many times a song has been rated.
                        var countKey = 'ratingCount_' + key;
                        var currentCount = parseInt(localStorage.getItem(countKey) || '0');
                        currentCount += 1;
                        localStorage.setItem(countKey, currentCount);
                        // Optionally store the last rating value; not publicly used.
                        localStorage.setItem('lastRating_' + key, value);

                        // Send rating to Supabase
                        try {
                            var songDiv = ratingContainer.closest('.song');
                            var titleEl = songDiv ? songDiv.querySelector('h3') : null;
                            var title = titleEl ? titleEl.textContent.trim() : key;
                            if (typeof updateSongStats === 'function') {
                                updateSongStats(key, title, 0, 1, value, 0);
                            }
                        } catch (err) {
                            // ignore errors when Supabase is not configured
                        }
                    }
                }
            });
            // Comment submission handler with user info check
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('comment-submit')) {
                    e.preventDefault();
                    // If user info has not been submitted, show modal and abort
                    if (!localStorage.getItem('userInfoSubmitted')) {
                        if (typeof showUserModal === 'function') {
                            showUserModal();
                        }
                        return;
                    }
                    var button = e.target;
                    var commentSection = button.parentElement;
                    var textarea = commentSection.querySelector('textarea');
                    var message = commentSection.querySelector('.comment-message');
                    var comment = textarea.value.trim();
                    if (comment.length === 0) {
                        return;
                    }
                    // Identify song key via closest .song element
                    var songDiv = button.closest('.song');
                    var playCounter = songDiv ? songDiv.querySelector('.play-count') : null;
                    if (playCounter) {
                        var key = playCounter.dataset.key;
                        var commentsKey = 'comments_' + key;
                        var existing = [];
                        try {
                            existing = JSON.parse(localStorage.getItem(commentsKey) || '[]');
                        } catch (err) {
                            existing = [];
                        }
                        existing.push(comment);
                        localStorage.setItem(commentsKey, JSON.stringify(existing));

                        // Send comment count to Supabase
                        try {
                            var songTitleEl = songDiv ? songDiv.querySelector('h3') : null;
                            var songTitle = songTitleEl ? songTitleEl.textContent.trim() : key;
                            if (typeof updateSongStats === 'function') {
                                updateSongStats(key, songTitle, 0, 0, 0, 1);
                            }
                        } catch (err) {
                            // ignore errors when Supabase is not configured
                        }
                    }
                    // Clear textarea and show thank you message
                    textarea.value = '';
                    if (message) {
                        message.style.display = 'block';
                        setTimeout(function () {
                            message.style.display = 'none';
                        }, 4000);
                    }
                }
            });

            // Album player functionality: sequential playback of all songs
            var playAllBtn = document.getElementById('play-all-btn');
            var albumPlayer = document.getElementById('album-player');
            var prevBtn = document.getElementById('prev-song-btn');
            var nextBtn = document.getElementById('next-song-btn');
            var stopBtn = document.getElementById('stop-player-btn');
            // Create an array from NodeList of audio elements for sequential control
            var albumAudios = Array.prototype.slice.call(audioElements);
            var albumPlaying = false;
            var playIndex = 0;
            /**
             * Play a song at the given index and update currentAudio. Stops any
             * currently playing track. If index is outside bounds, nothing happens.
             */
            function playSong(index) {
                if (index < 0 || index >= albumAudios.length) {
                    return;
                }
                // Pause and reset current audio if another song is playing
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                currentAudio = albumAudios[index];
                playIndex = index;
                albumPlaying = true;
                currentAudio.play();
            }
            /** Play the next song in the album (wrap to first if at end) */
            function playNext() {
                var nextIndex = playIndex + 1;
                if (nextIndex >= albumAudios.length) {
                    nextIndex = 0;
                }
                playSong(nextIndex);
            }
            /** Play the previous song in the album (wrap to last if at beginning) */
            function playPrev() {
                var prevIndex = playIndex - 1;
                if (prevIndex < 0) {
                    prevIndex = albumAudios.length - 1;
                }
                playSong(prevIndex);
            }
            /** Stop all playback and reset state */
            function stopAll() {
                albumPlaying = false;
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
            }
            // When the play-all button is clicked, show the album player and start with the first track
            if (playAllBtn && albumPlayer) {
                playAllBtn.addEventListener('click', function () {
                    // Show overlay and make sure songs list and back button are visible
                    albumPlayer.style.display = 'block';
                    if (songsContainer) {
                        songsContainer.style.display = 'grid';
                    }
                    if (backButton) {
                        backButton.style.display = 'inline-block';
                    }
                    playSong(0);
                });
            }
            // Hook up control buttons
            if (nextBtn) {
                nextBtn.addEventListener('click', function () {
                    playNext();
                });
            }
            if (prevBtn) {
                prevBtn.addEventListener('click', function () {
                    playPrev();
                });
            }
            if (stopBtn) {
                stopBtn.addEventListener('click', function () {
                    stopAll();
                });
            }
            // Automatically play next track when the current track ends, if album is playing
            albumAudios.forEach(function (aud) {
                aud.addEventListener('ended', function () {
                    if (albumPlaying) {
                        playNext();
                    }
                });
            });

            /**
             * Send a weekly summary of song ratings via a mailto link.  This function
             * checks when the last report was generated and, if more than seven days
             * have passed, compiles the rating counts for each song and opens the
             * user’s mail client with a pre‑filled email to contact@shockt-project.de.
             *
             * The summary lists each song title and the number of times it has been
             * rated.  The last sent time is stored in localStorage under
             * "ratingsReportLastSent" to avoid sending more than once per week.
             */
            function sendWeeklyRatingReport() {
                try {
                    var lastSentStr = localStorage.getItem('ratingsReportLastSent');
                    var now = new Date();
                    var send = false;
                    if (!lastSentStr) {
                        send = true;
                    } else {
                        var lastSentDate = new Date(lastSentStr);
                        // If more than 7 days have elapsed since the last report, send again
                        if (now - lastSentDate > 7 * 24 * 60 * 60 * 1000) {
                            send = true;
                        }
                    }
                    if (!send) {
                        return;
                    }
                    // Compile rating counts for each song
                    var reportLines = [];
                    document.querySelectorAll('#album-songs .song .play-count').forEach(function (counter) {
                        var key = counter.dataset.key;
                        var count = parseInt(localStorage.getItem('ratingCount_' + key) || '0', 10);
                        var titleEl = counter.parentElement.querySelector('h3');
                        var title = titleEl ? titleEl.textContent.trim() : key;
                        reportLines.push(title + ': ' + count + ' Bewertungen');
                    });
                    if (reportLines.length === 0) {
                        return;
                    }
                    var subject = encodeURIComponent('Wöchentlicher Bewertungsbericht');
                    var body = encodeURIComponent(reportLines.join('\n'));
                    var mailto = 'mailto:contact@shockt-project.de?subject=' + subject + '&body=' + body;
                    // Defer the mailto navigation slightly so it does not block page initialization
                    setTimeout(function () {
                        window.location.href = mailto;
                    }, 100);
                    localStorage.setItem('ratingsReportLastSent', now.toISOString());
                } catch (err) {
                    // Ignore storage or navigation errors silently
                }
            }
            // Trigger the weekly rating report on page load
            // sendWeeklyRatingReport();

            /**
             * Compile a weekly summary including page views, song play counts and
             * rating distributions for each song.  The summary is then passed to
             * a mailto link so the user’s email client can send the report to
             * contact@shockt-project.de.  The report is only sent once per
             * 7‑day period, based on the timestamp stored in localStorage
             * under "weeklyReportLastSent".  Rating distributions count how
             * many times each rating value (1–5) was recorded during the last
             * seven days.  If a rating entry in localStorage does not include
             * a timestamp (legacy numeric entries), it is treated as having
             * occurred within the current week.
             */
            function sendWeeklyReport() {
                try {
                    var lastSentStr = localStorage.getItem('weeklyReportLastSent');
                    var now = new Date();
                    var shouldSend = false;
                    if (!lastSentStr) {
                        shouldSend = true;
                    } else {
                        var lastSentDate = new Date(lastSentStr);
                        if (now - lastSentDate > 7 * 24 * 60 * 60 * 1000) {
                            shouldSend = true;
                        }
                    }
                    if (!shouldSend) {
                        return;
                    }
                    var oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    // Count page views within the last week
                    var pageViewsCount = 0;
                    try {
                        var pv = JSON.parse(localStorage.getItem('pageViews') || '[]');
                        pv.forEach(function (ts) {
                            try {
                                var d = new Date(ts);
                                if (isNaN(d.getTime()) || d >= oneWeekAgo) {
                                    pageViewsCount += 1;
                                }
                            } catch (ex) {
                                // treat invalid timestamps as within the week
                                pageViewsCount += 1;
                            }
                        });
                    } catch (ex) {
                        pageViewsCount = 0;
                    }
                    var reportLines = [];
                    reportLines.push('Seitenaufrufe (diese Woche): ' + pageViewsCount);
                    // Compile per-song play counts and rating distributions
                    document.querySelectorAll('#album-songs .song').forEach(function (songDiv) {
                        var titleEl = songDiv.querySelector('h3');
                        var title = titleEl ? titleEl.textContent.trim() : '';
                        var playCounter = songDiv.querySelector('.play-count');
                        var key = playCounter ? playCounter.dataset.key : null;
                        var playCount = 0;
                        if (key) {
                            // Count plays in the last week
                            try {
                                var histKey = 'playHistory_' + key;
                                var history = JSON.parse(localStorage.getItem(histKey) || '[]');
                                history.forEach(function (ts) {
                                    try {
                                        var d = new Date(ts);
                                        if (isNaN(d.getTime()) || d >= oneWeekAgo) {
                                            playCount += 1;
                                        }
                                    } catch (ex) {
                                        playCount += 1;
                                    }
                                });
                            } catch (ex) {
                                playCount = 0;
                            }
                        }
                        // Compute rating distribution 1–5 for this song
                        var distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                        if (key) {
                            try {
                                var ratingsKey = 'ratings_' + key;
                                var ratings = JSON.parse(localStorage.getItem(ratingsKey) || '[]');
                                ratings.forEach(function (entry) {
                                    var val = null;
                                    var dateVal = null;
                                    if (typeof entry === 'number') {
                                        val = entry;
                                        dateVal = null;
                                    } else if (entry && typeof entry === 'object' && 'value' in entry) {
                                        val = entry.value;
                                        dateVal = entry.date ? new Date(entry.date) : null;
                                    }
                                    if (val >= 1 && val <= 5) {
                                        if (!dateVal || isNaN(dateVal.getTime()) || dateVal >= oneWeekAgo) {
                                            distribution[val] = (distribution[val] || 0) + 1;
                                        }
                                    }
                                });
                            } catch (ex) {
                                // ignore errors
                            }
                        }
                        var ratingParts = [];
                        for (var i = 1; i <= 5; i++) {
                            ratingParts.push(i + ': ' + (distribution[i] || 0));
                        }
                        var line = title + ': ' + playCount + ' Abspielungen; Bewertungen – ' + ratingParts.join(' | ');
                        reportLines.push(line);
                    });
                    if (reportLines.length === 0) {
                        return;
                    }
                        // Compose email subject and body
                    var subject = encodeURIComponent('Wöchentlicher Bericht shockT project');
                    var body = encodeURIComponent(reportLines.join('\n'));
                    var mailtoLink = 'mailto:contact@shockt-project.de?subject=' + subject + '&body=' + body;
                    setTimeout(function () {
                        window.location.href = mailtoLink;
                    }, 200);
                    localStorage.setItem('weeklyReportLastSent', now.toISOString());
                } catch (err) {
                    // ignore errors
                }
            }
            // Trigger the weekly report on page load
            
            // endWeeklyReport();
        });
    </script>
    <!-- Supabase client and helper functions -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Initialize Supabase client. Replace placeholders with your Supabase URL and anon key.
      // Supabase project configuration
      // Use the project's REST endpoint as the Supabase URL and the provided
      // anon key for public client access. These values are safe to expose in
      // client-side code as long as Row Level Security (RLS) policies are
      // correctly configured in Supabase.
      const supabaseUrl = 'https://jycgeopnemncxdqkubam.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5Y2dlb3BuZW1uY3hkcWt1YmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NjkxOTksImV4cCI6MjA3MDI0NTE5OX0.libdmvl7SprUTCIMZVtP8E2HjoiSwFqs0Mb2I-He5jA';
      // Create a Supabase client instance. Use a distinct variable name (supabaseClient)
      // to avoid shadowing the global `supabase` object. If we reuse the name "supabase"
      // here, JavaScript will throw a ReferenceError due to the temporal dead zone.
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

      /**
       * Update song statistics in Supabase.
       *
       * @param {string} key - unique key for the song (e.g., data-key attribute)
       * @param {string} title - human-readable song title
       * @param {number} playDelta - increment for play_count
       * @param {number} ratingDelta - increment for rating_count
       * @param {number} ratingValue - value added to rating_total (0 if none)
       * @param {number} commentDelta - increment for comment_count
       */
      async function updateSongStats(key, title, playDelta = 0, ratingDelta = 0, ratingValue = 0, commentDelta = 0) {
        try {
          // Fetch existing record for this song
               const { data: existing } = await supabaseClient
            .from('song_stats')
            .select('*')
            .eq('song_key', key)
            .single();
          let play_count = existing?.play_count ?? 0;
          let rating_total = existing?.rating_total ?? 0;
          let rating_count = existing?.rating_count ?? 0;
          let comment_count = existing?.comment_count ?? 0;
          play_count += playDelta;
          rating_total += ratingValue;
          rating_count += ratingDelta;
          comment_count += commentDelta;
               await supabaseClient.from('song_stats').upsert({
            song_key: key,
            song_title: title,
            play_count,
            rating_total,
            rating_count,
            comment_count,
          });
        } catch (error) {
          // If Supabase is not configured or fails, silently ignore to avoid breaking the page
        }
      }
    </script>
    </body>
    </html>
